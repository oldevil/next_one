{% load staticfiles %}
<head>
    <meta name="mobile-web-app-capable" content="yes">
    <<link rel="shortcut icon" sizes="192x192" href="{% static '/img/favicon.png' %}">
    <link rel="apple-touch-icon" sizes="192x192" href="{% static '/img/favicon.png' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://apps.bdimg.com/libs/jquerymobile/1.4.5/jquery.mobile-1.4.5.min.css">
    <script src="http://apps.bdimg.com/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="http://apps.bdimg.com/libs/jquerymobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <title>Next One</title>
    <script src="{% static 'Sortable/Sortable.min.js' %}"></script>
</head>

<body>
<div data-role="page">
    <div data-role="header" data-position="fixed">
        <a href="{% url 'room:room_index' %}" class="ui-btn ui-corner-all ui-shadow ui-icon-back ui-btn-icon-left" data-ajax="false">后退</a>
        <h1>OR {{ room.number }}</h1>
    </div>
    <div data-role="main" class="ui-content">
        <h1>已接：</h1>
        <ul data-role="listview" data-inset="true" data-icon="false" id="got">
            {% for patient in patients_got %}
                <li data-id="{{ patient.id }}" id="{{ patient.id }}">{{ patient.name }}</li>
            {% endfor %}
        </ul>
        <h1>未接：</h1>
        <ul data-role="listview" data-inset="true" data-icon="false" id="getting">
            {% for patient in patients %}
                <li data-id="{{ patient.id }}" id="{{ patient.id }}">
                    <a href="{% url 'room:patient_detail' room.id patient.id %}" data-ajax="false">{{ patient.name }}</a>
                    <a href="javascript:void(0);" data-icon="delete" onclick="delete_patient({{ patient.id }})"></a>
                </li>
            {% endfor%}
        </ul>
        <h1>明日：</h1>
        <ul data-role="listview" data-inset="true" data-icon="false" id="tomorrow">
            {% for patient in patients_tomorrow %}
                <li data-id="{{ patient.id }}" id="{{ patient.id }}">
                    <a href="{% url 'room:patient_detail' room.id patient.id %}" data-ajax="false">{{ patient.name }}</a>
                    <a href="javascript:void(0);" data-icon="delete" onclick="delete_patient({{ patient.id }})"></a>
                </li>
            {% endfor %}
        </ul>
        <h1>计划：</h1>
        <ul data-role="listview" data-inset="true" data-icon="false" id="project">
            {% for patient in patients_in_project %}
                <li data-id="{{ patient.id }}" id="{{ patient.id }}">
                    <a href="{% url 'room:patient_detail' room.id patient.id %}" data-ajax="false">{{ patient.name }}</a>
                    <a href="javascript:void(0);" data-icon="delete" onclick="delete_patient({{ patient.id }})"></a>
                </li>
            {% endfor %}
        </ul>
        <form id="newpatient" name="newpatient" action="{% url 'room:patient_create' %}" method="post" data-ajax="false">
            <input type="hidden" name="room_id" id="room_id" value="{{ room.id }}">
        </form>
    </div>
    <div data-role="footer" data-position="fixed" style="text-align:center;">
        <button onclick="toggleDrag()" id="toggle">开始排序</button>
        <button onclick="fsubmit(document.newpatient)">添加患者</button>
    </div>
</div>
</body>

<script>
    ts = Date.now();

    function delete_patient(patient_id) {
        jQuery.ajax({
            url: "{% url 'room:patient_delete' %}",
            type: 'POST',
            dataType: 'text',
            data: {
                room_id: {{ room.id }},
                patient_id: patient_id,
            },
            success: function () {
                location.reload();
            },
            error: function (data) {
                alert(data.responseText);
                location.reload();
            }
        });
    }

    function update_queue(data) {
        jQuery.ajax({
            url: "{% url 'room:room_update_queue' room.id %}",
            type: 'POST',
            dataType: 'text',
            data,
            error: function (data) {
                alert(data.responseText);
                location.reload();
            },
        });
    }

    let getting = document.getElementById('getting');
    let sortable_getting = Sortable.create(getting, {
        group: {
            name: 'getting',
            put: ['got', 'tomorrow', 'project'],
            pull: ['tomorrow', 'project'],
        },
        disabled: true,
        onUpdate: function () {
            let order = sortable_getting.toArray();
            let positions = '[' + order.join(', ') + ']';
            let data = {
                value: ts,
                queue: positions,
                target: 'patient_queue',
            };
            update_queue(data);
        },
        onAdd: function (evt) {
            let order = sortable_getting.toArray();
            let positions = '[' + order.join(', ') + ']';
            let data = {
                value: ts,
                queue: positions,
                target: 'patient_queue',
                patient_id: evt.item.id,
                status: 0,
            };
            update_queue(data);
        },
    });

    let got = document.getElementById('got');
    let sortable_got = Sortable.create(got, {
        sort: false,
        group: {
            name: 'got',
            put: false,
            pull: ['getting', 'tomorrow', 'project'],
        },
        disabled: true,
    });

    let tomorrow = document.getElementById('tomorrow');
    let sortable_tomorrow = Sortable.create(tomorrow, {
        group: {
            name: 'tomorrow',
            put: ['got', 'getting', 'project'],
            pull: ['getting', 'project'],
        },
        disabled: true,
        onUpdate: function () {
            let order = sortable_tomorrow.toArray();
            let positions = '[' + order.join(', ') + ']';
            let data = {
                value: ts,
                queue: positions,
                target: 'patient_tomorrow_queue',
            };
            update_queue(data);
        },
        onAdd: function (evt) {
            let order = sortable_tomorrow.toArray();
            let positions = '[' + order.join(', ') + ']';
            let data = {
                value: ts,
                queue: positions,
                target: 'patient_tomorrow_queue',
                patient_id: evt.item.id,
                status: 2,
            };
            update_queue(data);
        },
    });

    let project = document.getElementById('project');
    let sortable_project = Sortable.create(project, {
        sort: false,
        group: {
            name: 'project',
            put: ['got', 'getting', 'tomorrow'],
            pull: ['getting', 'tomorrow'],
        },
        disabled: true,
        onAdd: function (evt) {
            let data = {
                value: ts,
                patient_id: evt.item.id,
                status: 3,
            };
            update_queue(data);
        },
    });

    function toggleDrag() {
        let toggle = document.getElementById('toggle');
        if (toggle.textContent === '开始排序') {
            jQuery.ajax({
                url: "{% url 'room:room_cache_api' %}",
                type: 'POST',
                dataType: "text",
                data: {
                    operation: 'get_or_set',
                    key: "room_{{ room.id }}_sorting",
                    value: ts,
                },
                success: function () {
                    localStorage.setItem('sort_tag', ts.toString());
                    location.reload();
                },
                error: function (data) {
                    alert(data.responseText);
                }
            });
        }
        else {
            jQuery.ajax({
                url: "{% url 'room:room_cache_api' %}",
                type: 'POST',
                dataType: "text",
                data: {
                    operation: 'delete',
                    key: "room_{{ room.id }}_sorting",
                    value: ts,
                },
            });
            location.reload();
        }
    }

    if (localStorage.getItem('sort_tag')) {
        ts = parseInt(localStorage.getItem('sort_tag'));
        localStorage.removeItem('sort_tag');
        sortable_getting.options.disabled = !sortable_getting.options.disabled;
        sortable_got.options.disabled = !sortable_got.options.disabled;
        sortable_tomorrow.options.disabled = !sortable_tomorrow.options.disabled;
        sortable_project.options.disabled = !sortable_project.options.disabled;
        let toggle = document.getElementById('toggle');
        toggle.textContent = '停止排序';
    }
</script>

<script>
    function fsubmit(obj){
        obj.submit();
    }
</script>